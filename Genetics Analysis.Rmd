---
title: "Genetics Analysis"
author: "Yubo Shen"
date: "2025-12-22"
output: pdf_document
---

```{r}
expr_counts <- t(model_df[, 101:60760])

#Screen the genes with low mean expression
keep_gene <- rowMeans(expr_counts >= 10) >= 0.20
expr_filt <- expr_counts[keep_gene, ]
dim(expr_filt)
```
Calculate the gene expression vst.

```{r}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(
  countData = round(expr_filt),
  colData   = model_df,
  design    = ~ 1
)

vsd <- vst(dds, blind = TRUE)
expr_vst <- assay(vsd)
```

Keep genes with the 75% largest variance.

```{r}
gene_var <- apply(expr_vst, 1, var, na.rm = TRUE)

cutoff <- quantile(gene_var, 0.25, na.rm = TRUE)
keep_var <- gene_var >= cutoff

expr_vst_filt <- expr_vst[keep_var, , drop = FALSE]

c(n_genes_before = nrow(expr_vst), n_genes_after = nrow(expr_vst_filt))
```

```{r}
saveRDS(list(expr_vst_filt = expr_vst_filt, model_df = model_df), file = "R data/Vst_varFiltered_ready.rds")
# obj <- readRDS("R data/Vst_varFiltered_ready.rds")
# expr_vst_filt <- obj$expr_vst_filt
# model_df <- obj$model_df
```

Univariate Cox gene

```{r}
library(survival)

time_col <- "OS_time_days"
event_col <- "OS_event"

y <- with(model_df, Surv(model_df[[time_col]], model_df[[event_col]]))

run_one_gene <- function(g){
  x <- as.numeric(expr_vst_filt[g, ])
  
  if (all(is.na(x))) return(c(beta=NA, se=NA, HR=NA, CI_l=NA, CI_u=NA, p=NA))
  if (sd(x, na.rm = TRUE) == 0) return(c(beta=NA, se=NA, HR=NA, CI_l=NA, CI_u=NA, p=NA))
  
  out <- tryCatch({
    fit <- coxph(y ~ x)
    s <- summary(fit)
    
    if (nrow(s$coef) < 1 || nrow(s$conf.int) < 1) {
    return(c(beta=NA, se=NA, HR=NA, CI_l=NA, CI_u=NA, p=NA))
    }
    c(
      beta = s$coef[1, "coef"],
      se   = s$coef[1, "se(coef)"],
      HR   = s$coef[1, "exp(coef)"],
      CI_l = s$conf.int[1, "lower .95"],
      CI_u = s$conf.int[1, "upper .95"],
      p    = s$coef[1, "Pr(>|z|)"]
    )
  }, error = function(e) {
    c(beta=NA, se=NA, HR=NA, CI_l=NA, CI_u=NA, p=NA)
  })
  out
}

genes <- rownames(expr_vst_filt)
stopifnot(all(genes %in% rownames(expr_vst_filt)))

res_mat <- t(sapply(genes, run_one_gene))
res <- as.data.frame(res_mat)
res$gene <- genes

res$FDR <- p.adjust(res$p, method = "BH")

res <- res[order(res$FDR, res$p), ]
head(res, 20)


```

```{r}
saveRDS(res, file = "R results/univariate_cox_gene.rds")
write.csv(res, file = "R results/univariate_cox_gene.csv", row.names = FALSE)
```

Check the results of the univariate cox gene analysis.

```{r}
n_total <- nrow(res)
n_tested <- sum(!is.na(res$p))
n_sig <- sum(res$FDR < 0.05, na.rm = TRUE)
  
c(n_total=n_total, n_tested=n_tested, n_sig=n_sig)
```

```{r}
summary(res$HR)
quantile(res$HR, c(0.01, 0.05, 0.5, 0.95, 0.99), na.rm = TRUE)
```
```{r}
library(ggplot2)

res$logFDR <- -log10(res$FDR)

ggplot(res, aes(x = log2(HR), y = logFDR)) + geom_point(alpha = 0.4) + geom_hline(yintercept = -log10(0.05), linetype = "dashed") + theme_minimal()
```

Multivariate genes cox regression

```{r}
library(survival)
library(glmnet)

X <- t(expr_vst_filt)
storage.mode(X) <- "double"

y <- with(model_df, Surv(OS_time_days, OS_event))
dim(X)
sum(model_df$OS_event)
```

```{r}
set.seed(42)

cvfit <- cv.glmnet(
  x = X,
  y = y,
  family = "cox",
  alpha = 0.5,
  nfolds = 10,
  standardize = TRUE
)

plot(cvfit)
cvfit$lambda.min
cvfit$lambda.max
```

We gonna use the lambda.min for the Elastic Net Cox Regression.

```{r}
library(glmnet)

b_1se <- coef(cvfit, s = "lambda.1se")
idx_1se <- which(as.numeric(b_1se) !=0)

sig_1se <- data.frame(
  gene = rownames(b_1se)[idx_1se],
  coef = as.numeric(b_1se)[idx_1se],
  stringsAsFactors = FALSE
)

b_min <- coef(cvfit, s = "lambda.min")
idx_min <- which(as.numeric(b_min) !=0)

sig_min <- data.frame(
  gene = rownames(b_min)[idx_min],
  coef = as.numeric(b_min)[idx_min],
  stringsAsFactors = FALSE
)

nrow(sig_1se)
nrow(sig_min)
```

```{r}
saveRDS(cvfit, "R results/elastic_net_cvfit.rds")
write.csv(sig_min, "R results/signature_lambdaMin_47 genes.csv")
saveRDS(sig_min, "R results/signature_lambdaMin_47 genes.rds")
```

Calculate the risk scores

```{r}
# stopifnot(all(colnames(expr_vst_filt) == rownames(model_df)))
X <- t(expr_vst_filt)

model_df$risk <- as.numeric(
  predict(cvfit, newx = X, s = "lambda.min", type = "link")
)

summary(model_df$risk)
```

```{r}
saveRDS(model_df, "R data/model_df_with_riskscores.rds")
```

Split the risk score groups.

```{r}
cut <- median(model_df$risk, na.rm = TRUE)
model_df$risk_group <- ifelse(model_df$risk >= cut, "High", "Low")
model_df$risk_group <- factor(model_df$risk_group, levels = c("Low", "High"))

table(model_df$risk_group)
```

KM plot and log rank p value

```{r}
library(survival)
library(survminer)

km_fit <- survfit(Surv(OS_time_days, OS_event) ~ risk_group, data = model_df)

p <- ggsurvplot(
  km_fit,
  data = model_df,

  size = 1.2,                 
  censor.size = 2.8,          
  conf.int = FALSE,

  pval = TRUE,
  pval.method = TRUE,
  pval.size = 4.5,
  pval.coord = c(300, 0.15),  

  xlab = "Time (days)",
  ylab = "Overall survival probability",
  break.time.by = 1000,       
  xlim = c(0, 8000),

  legend.title = "Risk group",
  legend.labs = c("Low", "High"),
  legend = c(0.80, 0.90),     

  palette = c("#2C3E50", "#E74C3C"),

  # risk table
  risk.table = TRUE,
  risk.table.height = 0.25,
  risk.table.title = "Number at risk",
  risk.table.y.text.col = TRUE,
  risk.table.y.text = FALSE, 

  ggtheme = theme_classic(base_size = 14),
  tables.theme = theme_classic(base_size = 12)
)
p$plot <- p$plot +
  theme(
    legend.key = element_blank(),
    plot.margin = margin(5.5, 12, 5.5, 5.5),
    axis.title = element_text(face = "bold")
  )

p$table <- p$table +
  theme(
    plot.margin = margin(0, 12, 0, 5.5)
  )
p

g <- survminer::arrange_ggsurvplots(
  list(p),
  print = FALSE
)

ggsave(
  filename = "R results/Figure_KM_OS_risk_group.pdf",
  plot = g,
  width = 8.5,
  height = 6.5
)

ggsave(
  filename = "R results/Figure_KM_OS_risk_group.png",
  plot = g,
  width = 8.5,
  height = 6.5,
  dpi = 300
)
```

Do cox regression for continuous risk and discrete risk
The 47-gene-riskscore has great ability for predicting the OS in the univariate analysis,.

```{r}
library(survival)
cox_risk_cont <- coxph(Surv(OS_time_days, OS_event) ~ risk, data = model_df)
summary(cox_risk_cont)


```

```{r}
saveRDS(
  list(
    km_fit = km_fit,
    cox_risk_cont = cox_risk_cont,
    cox_risk_grp = cox_risk_grp,
    model_df = model_df
  ),
  file = "R results/riskscore_KM_cox.rds"
)
```

Multivariate Cox for risk, age, stage and gender.
Risk score is still an important factor in this survival analysis part.

```{r}
library(survival)
cox_multi <- coxph(Surv(OS_time_days, OS_event) ~ risk + age_years + gender + ajcc_pathologic_stage, data = model_df)
summary(cox_multi)

s <- summary(cox_multi)

cox_multi_df <- data.frame(
  gene = rownames(s$coefficients),
  beta = s$coefficients[, "coef"],
  se   = s$coefficients[, "se(coef)"],
  HR   = s$coefficients[, "exp(coef)"],
  CI_lower = s$conf.int[, "lower .95"],
  CI_upper = s$conf.int[, "upper .95"],
  p = s$coefficients[, "Pr(>|z|)"],
  row.names = NULL,
  check.names = FALSE
)

write.csv(cox_multi_df, file = "R results/Multivariate_cox_results.csv")
```

Forest plot for cox_multi_df.

```{r}
library(dplyr)
library(ggplot2)
library(stringr)

# colnames(cox_multi_df)

df_forest_plot <- df_forest %>%
  mutate(
    label = case_when(
      term == "risk"        ~ "Risk score",
      term == "age_years"   ~ "Age (years)",
      term == "gendermale"  ~ "Male (vs Female)",

      str_detect(term, "^ajcc_pathologic_stage") ~
        str_replace(term, "^ajcc_pathologic_stage", ""),

      TRUE ~ term
    ),

    label = str_squish(label),
    
    order_key = case_when(
      label == "Stage IA"   ~ 1,
      label == "Stage IB"   ~ 2,
      label == "Stage II"   ~ 3,
      label == "Stage IIA"  ~ 4,
      label == "Stage IIB"  ~ 5,
      label == "Stage IIIA" ~ 6,
      label == "Stage IIIB" ~ 7,
      label == "Stage IV"   ~ 8,

      label == "Male (vs Female)" ~ 20,
      label == "Age (years)"      ~ 30,
      label == "Risk score"       ~ 40,

      TRUE ~ 99
    )
  ) %>%
  arrange(order_key) %>%
  mutate(
    label = factor(label, levels = rev(unique(label)))
  )

df_forest_plot_notation <- df_forest_plot %>%
  mutate(
    hr_ci_txt = sprintf("%.2f (%.2fâ€“%.2f)", hr, ci_lower, ci_upper),
    p_txt = case_when(
      is.na(p) ~ "",
      p < 0.001 ~ "<0.001",
      TRUE ~ sprintf("%.3f", p)
    ),
    sig = !is.na(p) & p < 0.05
  )


p_forest <- ggplot(df_forest_plot_notation, aes(x = hr, y = label)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +
  geom_point(size = 2.8) +
  scale_x_log10() +
  labs(
    x = "Hazard Ratio(log scale)",
    y = NULL,
    title = "Multivariable Cox Regression for DFS"
  ) +
  theme_classic(base_size = 12)

ggsave(
  filename = "R results/Figure_Forest_MultivariableCox.pdf",
  plot = p_forest,
  width = 8.5,
  height = 6.0
)

ggsave(
  filename = "R results/Figure_Forest_MultivariableCox.png",
  plot = p_forest,
  width = 8.5,
  height = 6.0,
  dpi = 300
)
```

Show the genes that are most important and significant.

```{r}
library(org.Hs.eg.db)
library(AnnotationDbi)
genes_47 <- sig_min$gene
genes_47_clean <- sub("\\..*$", "", genes_47)
head(genes_47)
head(genes_47_clean)

# BiocManager::install("org.Hs.eg.db")
map_df <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = genes_47_clean,
  keytype = "ENSEMBL",
  columns = c("SYMBOL", "GENENAME")
)

sig_min$ENSEMBL <- sub("\\..*$", "", sig_min$gene)

sig_annot <- merge(
  sig_min,
  map_df,
  by.x = "ENSEMBL",
  by.y = "ENSEMBL",
  all.x = TRUE
)

head(sig_annot)

table(is.na(sig_annot$SYMBOL))
```

Save the genes results.

```{r}
write.csv(
  sig_annot,
  file = "R results/ElasticNet_47genes_mapping_summary.csv",
  row.names = FALSE
)
```